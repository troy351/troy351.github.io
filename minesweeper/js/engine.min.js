/*! minesweeper.troy 2016-08-21 08:06:38 */
define(["exports","js/block.min"],function(a,b){"use strict";function c(a){return a&&a.__esModule?a:{default:a}}function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(a,"__esModule",{value:!0});var e=c(b),f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function(){function a(b){d(this,a),this.options=b,this._initGame(),this._initMap(),this._startGame()}return g(a,[{key:"_initGame",value:function(){var a=this;this.gameArea=document.getElementById(this.options.gameArea),this._menuWrapper=document.createElement("div"),this._menuWrapper.className="menu",this._menuWrapper.innerHTML="<span>Menu</span>",this._menu=document.createElement("ul"),this._menu.innerHTML='<li>Start</li><a class="gap"></a><li class="current">Easy</li><li>Normal</li><li>Hard</li><li>Custom</li>',this._menuWrapper.appendChild(this._menu),this.gameArea.appendChild(this._menuWrapper);var b=this._menuWrapper.getElementsByTagName("span")[0];b.addEventListener("click",function(c){a._menu.style.display="block",b.className="on",c.stopPropagation()}),window.addEventListener("click",function(c){a._menu.style.display="none",b.className=""}),this._menu.addEventListener("click",function(b){"LI"===b.srcElement.nodeName&&("Start"===b.srcElement.innerText?a._initMap():a.setLevel(b.srcElement.innerText))}),this._levelSelector=document.createElement("div"),this._levelSelector.className="custom-level",this._levelSelector.innerHTML='\n            <form>\n                <p>Width: <input type="text" title="width"></p>\n                <p>Height: <input type="text" title="height"></p>\n                <p>Mines: <input type="text" title="mines"></p>\n                <div><input type="submit" value="Submit"></div>\n                <div><input type="button" value="Cancel"></div>\n            </form>',document.body.appendChild(this._levelSelector);var c=document.createElement("div");c.className="main-game";var d=document.createElement("div");d.className="digital-wrapper",this._mines=document.createElement("span"),this._time=document.createElement("span"),this._time.innerHTML="000",this._face=document.createElement("div"),d.appendChild(this._mines),d.appendChild(this._face),d.appendChild(this._time),c.appendChild(d),this._face.addEventListener("click",function(){a._initMap()}),this.canvas=document.createElement("canvas"),this.canvas.innerText="Your browser does not support canvas, please upgrade your browser.",c.appendChild(this.canvas),this.gameArea.appendChild(c),e.default.size=this.options.blockSize,e.default.ctx=this.canvas.getContext("2d"),window.addEventListener("contextmenu",function(a){a.preventDefault()})}},{key:"_initMap",value:function(){this._mines.innerText=this._addZero(this.options.mineTotal),this.gameArea.style.width=this.options.blockSize*this.options.columns/2+"px",this.canvas.width=this.options.blockSize*this.options.columns,this.canvas.height=this.options.blockSize*this.options.rows,this.canvas.style.width=this.options.blockSize*this.options.columns/2+"px",this.canvas.style.height=this.options.blockSize*this.options.rows/2+"px",this.firstClick=!0,this.selectingLevel=!1,this.gameOver=!1,this.win=!1,this._face.className="normal",clearInterval(this.timer),this.map=[];for(var a=0;a<this.options.rows;a++){this.map[a]=[];for(var b=0;b<this.options.columns;b++)this.map[a][b]=new e.default("cover",0,a,b),this.map[a][b].draw(!1)}}},{key:"_setMines",value:function(a){for(var b=this,c=[],d=0;d<this.options.rows*this.options.columns;d++)d<this.options.mineTotal?c[d]=-1:c[d]=0;for(var e=this.options.rows*this.options.columns-1;e>0;e--){var f=Math.floor(Math.random()*e),g=c[e];c[e]=c[f],c[f]=g}for(var h=a.i*this.options.columns+a.j;c[h]===-1;){var i=Math.floor(Math.random()*this.options.rows*this.options.columns);if(0===c[i]){var j=c[h];c[h]=c[i],c[i]=j}}for(var k=0;k<this.options.rows;k++)for(var l=0;l<this.options.columns;l++)this.map[k][l].number=c[k*this.options.columns+l];for(var m=0;m<this.options.rows;m++)for(var n=0;n<this.options.columns;n++)if(this.map[m][n].number!==-1)for(var o=m-1;o<=m+1;o++)for(var p=n-1;p<=n+1;p++)o<this.options.rows&&o>=0&&p<this.options.columns&&p>=0&&this.map[o][p].number===-1&&this.map[m][n].number++;this._time.innerText="000",this.timer=setInterval(function(){b.time="add"},1e3)}},{key:"_updateMap",value:function(a,b,c){if(!(this.gameOver||this.win||this.selectingLevel)){if("l"!==a&&"lr"!==a||"down"!==b?"up"===b&&(this._face.className="normal"):this._face.className="click","r"===a)switch(this.map[c.i][c.j].type){case"cover":this.map[c.i][c.j].type="flag",this.mines=-1;break;case"flag":this.map[c.i][c.j].type="question",this.mines=1;break;case"question":this.map[c.i][c.j].type="cover"}if("l"===a&&"up"===b&&c!==!1){if(this.firstClick&&(this.firstClick=!1,this._setMines(c)),this.map[c.i][c.j].number===-1)return void this._gameOver(c);0===this.map[c.i][c.j].number?this._expandMap(c):this.map[c.i][c.j].type="number"}if("lr"===a&&"up"===b&&c!==!1&&"number"===this.map[c.i][c.j].type){for(var d=0,e=c.i-1;e<=c.i+1;e++)for(var f=c.j-1;f<=c.j+1;f++)e<this.options.rows&&e>=0&&f<this.options.columns&&f>=0&&"flag"===this.map[e][f].type&&d++;if(d===this.map[c.i][c.j].number)for(var g=c.i-1;g<=c.i+1;g++)for(var h=c.j-1;h<=c.j+1;h++)if(g<this.options.rows&&g>=0&&h<this.options.columns&&h>=0&&"cover"===this.map[g][h].type)switch(this.map[g][h].number){case 0:this._expandMap({i:g,j:h});break;case-1:return void this._gameOver({i:g,j:h});default:this.map[g][h].type="number"}}this.win=!0;for(var i=0;i<this.options.rows;i++)for(var j=0;j<this.options.columns;j++)this.map[i][j].number!==-1&&"number"!==this.map[i][j].type&&"blank"!==this.map[i][j].type&&(this.win=!1),"lr"!==a||"down"!==b&&"move"!==b?"l"!==a||"down"!==b&&"move"!==b||"cover"!==this.map[i][j].type?this.map[i][j].draw(!1):i===c.i&&j===c.j?this.map[i][j].draw(!0):this.map[i][j].draw(!1):Math.abs(c.i-i)<2&&Math.abs(c.j-j)<2?this.map[i][j].draw(!0):this.map[i][j].draw(!1);this.win&&this._gameWin()}}},{key:"_expandMap",value:function(a){a.i<this.options.rows&&a.i>=0&&a.j<this.options.columns&&a.j>=0&&(0===this.map[a.i][a.j].number?"blank"!==this.map[a.i][a.j].type&&(this.map[a.i][a.j].type="blank",this._expandMap({i:a.i,j:a.j-1}),this._expandMap({i:a.i,j:a.j+1}),this._expandMap({i:a.i+1,j:a.j-1}),this._expandMap({i:a.i+1,j:a.j+1}),this._expandMap({i:a.i-1,j:a.j-1}),this._expandMap({i:a.i-1,j:a.j+1}),this._expandMap({i:a.i-1,j:a.j}),this._expandMap({i:a.i+1,j:a.j})):this.map[a.i][a.j].type="number")}},{key:"_startGame",value:function(){var a=this,b=50,c=-1,d=0,e=null,f=function(b,c){var d=Math.floor(b/a.options.blockSize*2),e=Math.floor(c/a.options.blockSize*2);return e<a.options.rows&&e>=0&&d<a.options.columns&&d>=0&&{i:e,j:d}};if(window.hasOwnProperty("ontouchstart"))return void alert("This game doesn't support touch screen, please use a desktop browser.");var g=function(g){var h=f(g.offsetX,g.offsetY),i=null;g.button+c===2&&Date.now()-d<b?(clearTimeout(e),i="lr",a._updateMap(i,"down",h)):0===g.button?e=setTimeout(function(){i="l",a._updateMap(i,"down",h)},b):2===g.button&&(e=setTimeout(function(){i="r",a._updateMap(i,"down",h)},b)),d=Date.now(),c=g.button;var j=function(b){var c=f(b.offsetX,b.offsetY);"l"!==i&&"lr"!==i||a._updateMap(i,"move",c)},k=function b(c){var d=f(c.offsetX,c.offsetY);"l"!==i&&"lr"!==i||a._updateMap(i,"up",d),window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",j),window.addEventListener("mouseup",k)};this.canvas.addEventListener("mousedown",g)}},{key:"_gameOver",value:function(a){this.gameOver=!0;for(var b=0;b<this.options.rows;b++)for(var c=0;c<this.options.columns;c++)b===a.i&&c===a.j?this.map[b][c].drawBoom():this.map[b][c].number===-1?"cover"!==this.map[b][c].type&&"question"!==this.map[b][c].type||this.map[b][c].drawMine():"flag"===this.map[b][c].type&&this.map[b][c].drawWrong();clearInterval(this.timer),this._face.className="failed"}},{key:"_gameWin",value:function(){for(var a=0;a<this.options.rows;a++)for(var b=0;b<this.options.columns;b++)this.map[a][b].number===-1&&"flag"!==this.map[a][b].type&&(this.map[a][b].type="flag",this.map[a][b].draw(!1));clearInterval(this.timer),this._mines.innerText="000",this._face.className="win"}},{key:"_addZero",value:function(a,b){for(b=b||3,a+="";a.length<b;)a="0"+a;return a}},{key:"setLevel",value:function(a){var b=this,c=function(){switch(a){case"Easy":b.options.rows=9,b.options.columns=9,b.options.mineTotal=10,b._menu.innerHTML='<li>Start</li><a class="gap"></a><li class="current">Easy</li><li>Normal</li><li>Hard</li><li>Custom</li>';break;case"Normal":b.options.rows=16,b.options.columns=16,b.options.mineTotal=40,b._menu.innerHTML='<li>Start</li><a class="gap"></a><li>Easy</li><li class="current">Normal</li><li>Hard</li><li>Custom</li>';break;case"Hard":b.options.rows=16,b.options.columns=30,b.options.mineTotal=99,b._menu.innerHTML='<li>Start</li><a class="gap"></a><li>Easy</li><li>Normal</li><li class="current">Hard</li><li>Custom</li>';break;case"Custom":clearInterval(b.timer),b.selectingLevel=!0;var c=b._levelSelector.getElementsByTagName("input");return c[0].value=b.options.columns,c[1].value=b.options.rows,c[2].value=b.options.mineTotal,c[3].addEventListener("click",function(a){b._menu.innerHTML='<li>Start</li><a class="gap"></a><li>Easy</li><li>Normal</li><li>Hard</li><li class="current">Custom</li>',b._levelSelector.style.display="none";var d={rows:parseInt(c[1].value),columns:parseInt(c[0].value),mineTotal:parseInt(c[2].value)};b.options=d,b._initMap(),a.preventDefault()}),c[4].addEventListener("click",function(a){b._levelSelector.style.display="none",b.selectingLevel=!1}),b._levelSelector.style.display="block",{v:void 0};default:console.error("minesweeper: no such difficulty")}}();return"object"===("undefined"==typeof c?"undefined":f(c))?c.v:void this._initMap()}},{key:"mines",set:function(a){this._mines.innerText=this._addZero(parseInt(this._mines.innerText)+a)}},{key:"time",set:function(a){var b=parseInt(this._time.innerText)+1;b>=999&&clearInterval(this.timer),this._time.innerText=this._addZero(b)}},{key:"options",set:function(a){var b={gameArea:"",rows:9,columns:9,mineTotal:10};for(var c in b)void 0!==a[c]&&(b[c]=a[c]);b.rows>30&&(b.rows=30),b.rows<9&&(b.rows=9),b.columns>40&&(b.columns=40),b.columns<9&&(b.columns=9),b.mineTotal>b.rows*b.columns/4&&(b.mineTotal=Math.floor(b.rows*b.columns/4)),b.mineTotal<b.rows*b.columns/8&&(b.mineTotal=Math.floor(b.rows*b.columns/8)),b.blockSize=40,this._options=b},get:function(){return this._options}}]),a}();a.default=h});