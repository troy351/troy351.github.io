/*! minesweeper.troy 2016-08-21 01:11:08 */
define(["exports","js/block.min"],function(a,b){"use strict";function c(a){return a&&a.__esModule?a:{default:a}}function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(a,"__esModule",{value:!0});var e=c(b),f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=function(){function a(b){d(this,a),this.options=b,this._initGame(),this._initMap(),this._startGame()}return f(a,[{key:"_initGame",value:function(){var a=this;this.gameArea=document.getElementById(this.options.gameArea),this.levelSelector=document.createElement("p"),this.levelSelector.innerHTML="<a>Easy</a><a>Normal</a><a>Hard</a>",this.gameArea.appendChild(this.levelSelector),this.levelSelector.addEventListener("click",function(b){"A"===b.srcElement.nodeName&&a.setLevel(b.srcElement.innerText.toLowerCase())});var b=document.createElement("div");this._mines=document.createElement("span"),this._time=document.createElement("span"),this._time.innerHTML="000",this._face=document.createElement("div"),b.appendChild(this._mines),b.appendChild(this._face),b.appendChild(this._time),this.gameArea.appendChild(b),this._face.addEventListener("click",function(b){var c=b.srcElement;c.className="normal",a._initMap()}),this.canvas=document.createElement("canvas"),this.canvas.innerText="Your browser does not support canvas, please upgrade your browser.",this.gameArea.appendChild(this.canvas),e.default.size=this.options.blockSize,e.default.ctx=this.canvas.getContext("2d"),window.addEventListener("contextmenu",function(a){a.preventDefault()})}},{key:"_initMap",value:function(){this._mines.innerText=this._addZero(this.options.mineCount),this.gameArea.style.width=this.options.blockSize*this.options.columns/2+"px",this.canvas.width=this.options.blockSize*this.options.columns,this.canvas.height=this.options.blockSize*this.options.rows,this.canvas.style.width=this.options.blockSize*this.options.columns/2+"px",this.canvas.style.height=this.options.blockSize*this.options.rows/2+"px",this.firstClick=!0,this.gameOver=!1,this.win=!1,this._face.className="normal",clearInterval(this.timer),this.map=[];for(var a=0;a<this.options.rows;a++){this.map[a]=[];for(var b=0;b<this.options.columns;b++)this.map[a][b]=new e.default("cover",0,a,b),this.map[a][b].draw(!1)}}},{key:"_setMines",value:function(a){for(var b=this,c=[],d=0;d<this.options.rows*this.options.columns;d++)d<this.options.mineCount?c[d]=-1:c[d]=0;for(var e=1;e<this.options.rows*this.options.columns;e++){var f=Math.ceil(Math.random()*e),g=c[e];c[e]=c[f],c[f]=g}for(var h=a.i*this.options.rows+a.j;c[h]===-1;){var i=Math.ceil(Math.random()*this.options.rows*this.options.columns);if(0===c[i]){var j=c[h];c[h]=c[i],c[i]=j}}for(var k=0;k<this.options.rows;k++)for(var l=0;l<this.options.columns;l++)this.map[k][l].number=c[k*this.options.rows+l];for(var m=0;m<this.options.rows;m++)for(var n=0;n<this.options.columns;n++)if(this.map[m][n].number!==-1)for(var o=m-1;o<=m+1;o++)for(var p=n-1;p<=n+1;p++)o<this.options.rows&&o>=0&&p<this.options.columns&&p>=0&&this.map[o][p].number===-1&&this.map[m][n].number++;this._time.innerText="000",this.timer=setInterval(function(){b.time="add"},1e3)}},{key:"_updateMap",value:function(a,b,c){if(!this.gameOver&&!this.win){if("l"!==a&&"lr"!==a||"down"!==b?"up"===b&&(this._face.className="normal"):this._face.className="click","r"===a)switch(this.map[c.i][c.j].type){case"cover":this.map[c.i][c.j].type="flag",this.mines=-1;break;case"flag":this.map[c.i][c.j].type="question",this.mines=1;break;case"question":this.map[c.i][c.j].type="cover"}if("l"===a&&"up"===b&&c!==!1){if(this.firstClick&&(this.firstClick=!1,this._setMines(c)),this.map[c.i][c.j].number===-1)return void this._gameOver(c);0===this.map[c.i][c.j].number?this._expandMap(c):this.map[c.i][c.j].type="number"}if("lr"===a&&"up"===b&&c!==!1&&"number"===this.map[c.i][c.j].type){for(var d=0,e=c.i-1;e<=c.i+1;e++)for(var f=c.j-1;f<=c.j+1;f++)e<this.options.rows&&e>=0&&f<this.options.columns&&f>=0&&"flag"===this.map[e][f].type&&d++;if(d===this.map[c.i][c.j].number)for(var g=c.i-1;g<=c.i+1;g++)for(var h=c.j-1;h<=c.j+1;h++)if(g<this.options.rows&&g>=0&&h<this.options.columns&&h>=0&&"cover"===this.map[g][h].type)switch(this.map[g][h].number){case 0:this._expandMap({i:g,j:h});break;case-1:return void this._gameOver({i:g,j:h});default:this.map[g][h].type="number"}}this.win=!0;for(var i=0;i<this.options.rows;i++)for(var j=0;j<this.options.columns;j++)this.map[i][j].number!==-1&&"number"!==this.map[i][j].type&&"blank"!==this.map[i][j].type&&(this.win=!1),"lr"!==a||"down"!==b&&"move"!==b?"l"!==a||"down"!==b&&"move"!==b||"cover"!==this.map[i][j].type?this.map[i][j].draw(!1):i===c.i&&j===c.j?this.map[i][j].draw(!0):this.map[i][j].draw(!1):Math.abs(c.i-i)<2&&Math.abs(c.j-j)<2?this.map[i][j].draw(!0):this.map[i][j].draw(!1);this.win&&this._gameWin()}}},{key:"_expandMap",value:function(a){a.i<this.options.rows&&a.i>=0&&a.j<this.options.columns&&a.j>=0&&(0===this.map[a.i][a.j].number?"blank"!==this.map[a.i][a.j].type&&(this.map[a.i][a.j].type="blank",this._expandMap({i:a.i,j:a.j-1}),this._expandMap({i:a.i,j:a.j+1}),this._expandMap({i:a.i+1,j:a.j-1}),this._expandMap({i:a.i+1,j:a.j+1}),this._expandMap({i:a.i-1,j:a.j-1}),this._expandMap({i:a.i-1,j:a.j+1}),this._expandMap({i:a.i-1,j:a.j}),this._expandMap({i:a.i+1,j:a.j})):this.map[a.i][a.j].type="number")}},{key:"_startGame",value:function(){var a=this,b=50,c=-1,d=0,e=null,f=function(b,c){var d=Math.floor(b/a.options.blockSize*2),e=Math.floor(c/a.options.blockSize*2);return e<a.options.rows&&e>=0&&d<a.options.columns&&d>=0&&{i:e,j:d}};if(window.hasOwnProperty("ontouchstart"))return void alert("This game doesn't support touch screen, please use a desktop browser.");var g=function(g){var h=f(g.offsetX,g.offsetY),i=null;g.button+c===2&&Date.now()-d<b?(clearTimeout(e),i="lr",a._updateMap(i,"down",h)):0===g.button?e=setTimeout(function(){i="l",a._updateMap(i,"down",h)},b):2===g.button&&(e=setTimeout(function(){i="r",a._updateMap(i,"down",h)},b)),d=Date.now(),c=g.button;var j=function(b){var c=f(b.offsetX,b.offsetY);"l"!==i&&"lr"!==i||a._updateMap(i,"move",c)},k=function b(c){var d=f(c.offsetX,c.offsetY);"l"!==i&&"lr"!==i||a._updateMap(i,"up",d),window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",j),window.addEventListener("mouseup",k)};this.canvas.addEventListener("mousedown",g)}},{key:"_gameOver",value:function(a){this.gameOver=!0;for(var b=0;b<this.options.rows;b++)for(var c=0;c<this.options.columns;c++)b===a.i&&c===a.j?this.map[b][c].drawBoom():this.map[b][c].number===-1?"cover"!==this.map[b][c].type&&"question"!==this.map[b][c].type||this.map[b][c].drawMine():"flag"===this.map[b][c].type&&this.map[b][c].drawWrong();clearInterval(this.timer),this._face.className="failed"}},{key:"_gameWin",value:function(){for(var a=0;a<this.options.rows;a++)for(var b=0;b<this.options.columns;b++)this.map[a][b].number===-1&&"flag"!==this.map[a][b].type&&(this.map[a][b].type="flag",this.map[a][b].draw(!1));clearInterval(this.timer),this._mines.innerText="000",this._face.className="win"}},{key:"_addZero",value:function(a,b){for(b=b||3,a+="";a.length<b;)a="0"+a;return a}},{key:"setLevel",value:function(a){switch(a){case"easy":this.options.rows=9,this.options.columns=9,this.options.mineCount=10;break;case"normal":this.options.rows=16,this.options.columns=16,this.options.mineCount=40;break;case"hard":this.options.rows=16,this.options.columns=30,this.options.mineCount=99;break;default:console.error("minesweeper: no such difficulty")}this._initMap()}},{key:"mines",set:function(a){this._mines.innerText=this._addZero(parseInt(this._mines.innerText)+a)}},{key:"time",set:function(a){var b=parseInt(this._time.innerText)+1;b>=999&&clearInterval(this.timer),this._time.innerText=this._addZero(b)}},{key:"options",set:function(a){var b={gameArea:"",rows:9,columns:9,mineCount:10};for(var c in b)void 0!==a[c]&&(b[c]=a[c]);b.rows>30&&(b.rows=30),b.columns>40&&(b.columns=40),b.rows*b.columns/4<b.mineCount&&(b.mineCount=Math.floor(b.rows*b.columns/4)),b.blockSize=40,this._options=b},get:function(){return this._options}}]),a}();a.default=g});